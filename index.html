<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kings and Priests Leaderboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* Your existing styles */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f4;
            background-image: linear-gradient(135deg, #e9e9e9 25%, transparent 25%), 
                              linear-gradient(225deg, #e9e9e9 25%, transparent 25%), 
                              linear-gradient(45deg, #e9e9e9 25%, transparent 25%), 
                              linear-gradient(315deg, #e9e9e9 25%, #f4f4f4 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 10px 10px;
            background-repeat: repeat;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            font-size: 1.2em;
        }
        h1, h3 {
            margin-bottom: 0;
            color: #333;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            max-width: 600px;
            margin: 0;
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            text-align: left;
            padding: 10px;
        }
        th {
            background-color: #3d228f;
            color: white;
        }
        tr:nth-child(odd) {
            background-color: #e7e2f5;
        }
        tr:nth-child(even) {
            background-color: #f1ecff;
        }
        tr.orange {
            background-color: orange;
            color: white;
        }
        @media (max-width: 600px) {
            table {
                font-size: 14px;
            }
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 0;">Kings and Priests</h1>
    <h3 style="margin-top: 0;">Fitness Leaderboard</h3>

    <label for="currentWeek">Set Current Week:</label>
    <select id="currentWeek">
        <option value="1">Week 1</option>
        <option value="2">Week 2</option>
        <option selected="selected" value="3">Week 3</option>
        <option value="4">Week 4</option>
        <option value="5">Week 5</option>
    </select>

    <h2 style="color: #444;">This Week</h2>
    <table id="weeklyLeaderboard">
        <thead>
            <tr>
                <th style="width: 10%;">Rank</th>
                <th style="width: 50%;">Name</th>
                <th style="width: 40%;">Score</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be dynamically inserted here -->
        </tbody>
    </table>

    <h2 style="color: #444;">Whole Month</h2>
    <table id="monthlyLeaderboard">
        <thead>
            <tr>
                <th style="width: 10%;">Rank</th>
                <th style="width: 50%;">Name</th>
                <th style="width: 40%;">Score</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be dynamically inserted here -->
        </tbody>
    </table>

    <h2 style="color: #444; text-align: center; margin-bottom: 0;">All Scores Updated Weekly!</h2>
    <p style="margin: 0;" id="lastUpdated">Last Updated: --</p>

    <script src="config.js"></script>
    <script>
        // Function to fetch data from Google Sheets
        async function fetchDataFromGoogleSheets() {
            const apiKey = config.apiKey;
            const spreadsheetId = config.spreadsheetId;
            const range = 'Sheet1!A1:BB25'; // Adjusted range to cover all necessary columns

            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            return data.values;
        }

        // Function to process and use the fetched data
        function processPlayerData(sheetData) {
            const playersData = [];

            // Loop through the rows from 7 to 25 to get player data
            for (let rowIndex = 6; rowIndex <= 24; rowIndex++) {
                const row = sheetData[rowIndex];
                const playerName = row[1]; // Column B (Index 1) for player names
                const weekScores = [
                    parseFloat(row[9]) || 0,  // Column J (Index 9) for Week 1 scores
                    parseFloat(row[20]) || 0, // Column U (Index 20) for Week 2 scores
                    parseFloat(row[31]) || 0, // Column AF (Index 31) for Week 3 scores
                    parseFloat(row[42]) || 0, // Column AG (Index 32) for Week 4 scores
                    parseFloat(row[53]) || 0  // Column BB (Index 53) for Week 5 scores
                ];

                playersData.push({ name: playerName, weekScores: weekScores });
            }

            return playersData;
        }

        // Function to calculate the total score for each player
        function calculateTotalScores(playersData) {
            return playersData.map(player => {
                const totalScore = player.weekScores.reduce((acc, score) => acc + score, 0);
                return { name: player.name, score: totalScore };
            });
        }

        // Function to generate the leaderboard for "This Week"
        function generateWeeklyLeaderboard(playersData, currentWeek) {
            const leaderboard = playersData
                .map(player => {
                    return { name: player.name, score: player.weekScores[currentWeek - 1] };
                })
                .filter(player => player.score > 0) // Only include players with scores greater than 0
                .sort((a, b) => b.score - a.score);

            populateTable("weeklyLeaderboard", leaderboard);
        }

        // Function to generate the leaderboard for "This Month"
        function generateMonthlyLeaderboard(playersData) {
            const leaderboard = calculateTotalScores(playersData).sort((a, b) => b.score - a.score);
            populateTable("monthlyLeaderboard", leaderboard);
        }

        // Function to populate the table with data
        function populateTable(tableId, data) {
            const tableBody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            tableBody.innerHTML = "";
            data.forEach((entry, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td>${index + 1}</td><td>${entry.name}</td><td>${entry.score}</td>`;
                if (index === 0) row.classList.add("orange");
            });
        }

        // Initial load
        document.addEventListener("DOMContentLoaded", async () => {
            const currentWeekSelect = document.getElementById('currentWeek');
            let currentWeek = parseInt(currentWeekSelect.value);

            // Fetch and process the data from Google Sheets
            const sheetData = await fetchDataFromGoogleSheets();
            const playersData = processPlayerData(sheetData);

            // Generate leaderboards on page load
            generateWeeklyLeaderboard(playersData, currentWeek);
            generateMonthlyLeaderboard(playersData);

            // Update leaderboards when the current week changes
            currentWeekSelect.addEventListener('change', (event) => {
                currentWeek = parseInt(event.target.value);
                generateWeeklyLeaderboard(playersData, currentWeek);
            });

            // Update the last updated time
            document.getElementById('lastUpdated').textContent = `Last Updated: ${new Date().toLocaleString()}`;
        });
    </script>
</body>
</html>
